<script>
var elunrIndex, $results, s_idx;

// Initialize lunrjs using our generated index file
function initLunr() {
    // First retrieve the index file
    $.getJSON("./search_index.json")
        .done(function(index) {
            s_idx = index;
            //console.log("index:", s_idx);

            // Set up lunrjs by declaring the fields we use
            // Also provide their boost level for the ranking
            elunrIndex = elasticlunr(function() {
                this.addField("title");
                //this.addField("tags");
                this.setRef("href"); // ref := result item identifier (page URL
                this.addField("content");
            }, this);
            //console.log(getMethods(elunrIndex));  
            // Feed lunr with each file and let lunr actually index them
            s_idx.forEach(function(page) { 
                console.log(page);
                elunrIndex.addDoc(page);
            });      
        })
        .fail(function(jqxhr, textStatus, error) {
            var err = textStatus + ", " + error;
            console.error("Error getting Hugo index flie:", err);
        });
}

function getMethods(obj)
{
    var res = [];
    for(var m in obj) {
        if(typeof obj[m] == "function") {
            res.push(m)
        }
    }
    return res;
}

// Nothing crazy here, just hook up a listener on the input field
function initUI() {
    $results = $("#search-results");
    $("#search").keyup(function() {
        $results.empty();


        // Only trigger a search when at least  2 characters have been provided
        var query = $(this).val();
        if (query.length < 2) { return; }
        console.log("Query: "+query);
        var results = search(query);
        console.log(results); 
        renderResults(results);
    });
}


 /**
 * Trigger a search in lunr and transform the result
 *
 * @param  {String} query
 * @return {Array}  results
 */
function search(query) {
    // Find the item in our index corresponding to the lunr one to have more info
    // Lunr result: 
    //  {ref: "/section/page1", score: 0.2725657778206127}
    // Our result:
    //  {title:"Page1", href:"/section/page1", ...}
    return elunrIndex.search(query).map(function(result) {
            return s_idx.filter(function(page) {
                return page.href === result.ref;
            })[0];
        });
}

/**
 * Display the 10 first results
 *
 * @param  {Array} results to display
 */
function renderResults(results) {
    if (!results.length) { return; }

    console.log($paginator);
    // Only show the ten first results
    results.slice(0, 10).forEach(function(result) {

        // var $result = $("<li>");
        // $result.append($("<a>", {
        //     href: result.href,
        //     text: "Â» " + result.title
        // }));
        // $results.append($result);

    });
}

// Start lunr
initLunr();

$(document).ready(function() {
    initUI();
});
</script>